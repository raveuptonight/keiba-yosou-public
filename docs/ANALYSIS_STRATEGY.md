# 分析手法戦略

Qiita記事を参考にした機械学習 + LLMハイブリッド予想システム。

**参考記事:** https://qiita.com/teco_ito/items/171865d1d6227a5e85e8

---

## 参考記事の要点

### 使用データ
- **期間**: 2000-2012年（約12年分）
- **データソース**: JRA-VANデータラボ
- **特徴量**:
  - 馬齢
  - 騎手コード
  - 調教師コード
  - 馬主コード
  - 負担重量
  - 競馬場コード
  - 性別・品種・毛色コード
- **目的変数**: 確定後の順位

### 分析手法
- **モデル**: Lasso回帰（線形回帰）
- **出力**: スコア（14〜16の範囲、1に近いほど1着の可能性が高い）
- **環境**: Google Colaboratory

### 結果
- 予想: 3-2-8
- 実際: 8-12-15
- 評価: 精度は高くない

---

## 本プロジェクトへの適用戦略

### 🎯 アプローチ1: ハイブリッド予想（推奨）

**機械学習 + LLM の二段構え**

```
┌─────────────────────────┐
│  JRA-VANデータ          │
│  ・過去走データ          │
│  ・騎手・調教師成績      │
│  ・コース適性            │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│  特徴量エンジニアリング  │
│  ・スピード指数          │
│  ・上がり3F順位          │
│  ・馬場差補正            │
│  ・騎手勝率              │
└──────┬──────────────────┘
       │
       ├──────────┬─────────────┐
       ▼          ▼             ▼
┌──────────┐ ┌──────────┐ ┌──────────────┐
│ Lasso回帰│ │ XGBoost  │ │ LLM (Gemini) │
│ (基礎)   │ │ (高精度) │ │ (洞察力)     │
└──────┬───┘ └──────┬───┘ └──────┬───────┘
       │          │             │
       └──────────┴─────────────┘
                  ▼
         ┌─────────────────┐
         │  統合予想        │
         │  ・機械学習スコア │
         │  ・LLM分析結果   │
         │  ・最終順位予想  │
         └─────────────────┘
```

**メリット:**
- 機械学習で客観的なスコアを算出
- LLMで文脈や展開を考慮
- 両方の長所を活かせる

---

### 🔵 アプローチ2: LLM入力の強化（現実的）

**特徴量をLLMプロンプトに含める**

現在のLLMプロンプトに機械学習で計算した特徴量を追加：

```python
# 特徴量計算
features = calculate_features(race_data)

# LLMプロンプトに含める
prompt = f"""
【レース情報】
...

【各馬の分析指標】
1番 サンプルホース1
  - スピード指数: 85.3
  - 上がり3F順位平均: 2.1位
  - 騎手勝率: 0.15
  - 調教師勝率: 0.12
  - コース適性スコア: 0.78
  - 予想着順スコア: 14.2 ← 機械学習モデル出力

2番 サンプルホース2
  ...

【予想タスク】
上記の分析指標も考慮して、レース展開と着順を予想してください。
"""
```

**メリット:**
- 既存システムに追加するだけ
- 実装が簡単
- LLMが数値データを理解して予想

---

### 🟢 アプローチ3: 段階的予想（高度）

**フェーズ1〜3に機械学習を組み込む**

**現在:**
```
Phase 1: データ分析（LLM）
Phase 2: 予想生成（LLM）
Phase 3: 反省・改善（LLM）
```

**改良:**
```
Phase 0: 特徴量計算（機械学習） ← 追加
  ↓
Phase 1: データ分析（LLM + 特徴量）
  ↓
Phase 2: 予想生成（LLM + MLスコア）
  ↓
Phase 3: 反省・改善（LLM + 実際の結果 + 特徴量の寄与度）
```

---

## 実装する特徴量（優先順位付き）

### 🔴 必須（短期実装）

1. **スピード指数**
   - 走破タイム ÷ （馬場差 × 距離補正）
   - 過去5走の平均

2. **上がり3F順位**
   - 直近5走の上がり3F順位平均
   - レース展開を読むヒント

3. **騎手勝率**
   - 直近100走の勝率
   - コース別・距離別

4. **調教師勝率**
   - 直近100走の勝率
   - コース別

### 🟡 推奨（中期実装）

5. **コース適性スコア**
   - 過去のコース成績
   - 芝/ダート、距離別

6. **馬場差補正**
   - 当日の馬場状態を考慮
   - 過去の馬場別成績

7. **クラス補正**
   - 昇級・降級の影響
   - クラス別勝率

### 🟢 オプション（長期実装）

8. **血統スコア**
   - 父馬・母父馬のコース適性
   - 芝/ダート適性

9. **ペース指標**
   - 前半3F・後半3Fのラップ
   - 逃げ馬・追込馬の有利不利

10. **枠順補正**
    - コース別の枠順有利不利

---

## 技術スタック

### 機械学習モデル

**選択肢:**

1. **Lasso回帰**（記事の手法）
   - シンプル
   - 解釈性が高い
   - 線形関係しか捉えられない

2. **XGBoost**（推奨）
   - 高精度
   - 非線形関係も捉える
   - Kaggleでよく使われる

3. **LightGBM**
   - XGBoostより高速
   - メモリ効率が良い

4. **ニューラルネットワーク**
   - 最も高度
   - データ量が必要
   - 解釈性が低い

**推奨: XGBoost**
- バランスが良い
- scikit-learnライクなAPI
- 特徴量重要度が見える

### ライブラリ

```python
# 追加する依存関係
pip install xgboost
pip install scikit-learn
pip install pandas
pip install numpy
```

---

## ディレクトリ構成（追加分）

```
keiba-yosou/
├── src/
│   ├── features/          # 特徴量生成 ← 新規
│   │   ├── __init__.py
│   │   ├── speed_index.py      # スピード指数
│   │   ├── jockey_stats.py     # 騎手成績
│   │   ├── trainer_stats.py    # 調教師成績
│   │   ├── course_fit.py       # コース適性
│   │   └── feature_pipeline.py # 統合パイプライン
│   │
│   ├── models/            # 機械学習モデル ← 新規
│   │   ├── __init__.py
│   │   ├── base_model.py       # ベースクラス
│   │   ├── lasso_model.py      # Lasso回帰
│   │   ├── xgboost_model.py    # XGBoost
│   │   └── ensemble.py         # アンサンブル
│   │
│   └── pipeline.py        # 既存（改修）
│
├── notebooks/             # 分析用ノートブック ← 新規
│   ├── 01_data_exploration.ipynb
│   ├── 02_feature_engineering.ipynb
│   └── 03_model_training.ipynb
│
└── models/                # 学習済みモデル保存 ← 新規
    ├── xgboost_v1.pkl
    └── feature_scaler.pkl
```

---

## 実装ステップ

### Phase 1: 特徴量エンジニアリング（1週間）

1. JRA-VANデータからの特徴量抽出
2. スピード指数計算
3. 騎手・調教師成績集計
4. データクレンジング

### Phase 2: モデル訓練（3日）

1. 過去データで学習
2. 交差検証
3. ハイパーパラメータチューニング
4. モデル保存

### Phase 3: LLM統合（3日）

1. プロンプトに特徴量を追加
2. 予想ロジック改修
3. 精度検証

### Phase 4: 検証・改善（継続）

1. 実レースでテスト
2. 的中率・回収率測定
3. フィードバックループ

---

## 予想精度向上の鍵

### 記事の失敗から学ぶ

**なぜ精度が低かったか:**
- 線形モデルでは競馬の複雑さを捉えきれない
- 特徴量が不足（馬場状態、展開、血統など）
- 古いデータのみ（2000-2012年）

**本プロジェクトでの改善:**
- ✅ XGBoostで非線形関係を捉える
- ✅ 豊富な特徴量（JRA-VAN全データ）
- ✅ LLMで文脈・展開を理解
- ✅ 最新データ（1986年〜現在）

---

## 次のアクション

どのアプローチで進めますか？

1. **アプローチ2（推奨）**: LLM入力の強化
   - 実装が簡単
   - すぐに効果が見込める
   - 既存システムに追加するだけ

2. **アプローチ1（本格）**: ハイブリッド予想
   - 高精度が期待できる
   - 実装に時間がかかる
   - 機械学習の知識が必要

3. **段階的実装**: 2 → 1 の順で実装
   - まず簡単な方から試す
   - 効果を見ながら本格化

どれにしますか？

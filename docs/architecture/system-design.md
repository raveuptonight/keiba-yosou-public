# System Design

keiba-yosoのシステムアーキテクチャを説明します。

## 概要

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Docker Compose                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐│
│  │ Scheduler│  │   API    │  │ Discord  │  │   ML     │  │ Redis  ││
│  │ (Ofelia) │  │(FastAPI) │  │   Bot    │  │ Trainer  │  │        ││
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────────┘│
│       │             │             │             │                   │
│       └─────────────┴──────┬──────┴─────────────┘                   │
│                            │                                        │
│                     ┌──────┴──────┐                                 │
│                     │ PostgreSQL  │                                 │
│                     │ (mykeibadb) │                                 │
│                     └─────────────┘                                 │
└─────────────────────────────────────────────────────────────────────┘
```

## コンポーネント

### FastAPI (API Server)

- REST APIエンドポイントを提供
- 予想生成リクエストを処理
- ポート8000で稼働

### Discord Bot

- 自動通知（レース30分前）
- スラッシュコマンド対応
- APIサーバーと連携

### ML Trainer

- 週次モデル再学習
- 結果収集・分析
- Ofeliaスケジューラーで定期実行

### Scheduler (Ofelia)

- Cronベースのジョブスケジューリング
- 火曜18:00: 結果収集
- 火曜23:00: モデル再学習

### Redis

- オッズキャッシュ（60秒TTL）
- バイアスデータキャッシュ（1時間TTL）
- コードマスターキャッシュ（24時間TTL）

### PostgreSQL (mykeibadb)

- JRA-VANデータストレージ
- 予想結果の永続化
- ホストマシンで稼働

## データフロー

### 予想生成フロー

```
1. リクエスト受信 (API)
   ↓
2. レースデータ取得 (PostgreSQL)
   ↓
3. 特徴量抽出 (FeatureExtractor)
   ↓
4. ML予測実行 (Ensemble Model)
   ↓
5. 確率キャリブレーション (Isotonic)
   ↓
6. EV計算 (EVRecommender)
   ↓
7. 結果返却 & 保存
```

### 週次再学習フロー

```
1. 結果収集 (火曜18:00)
   - 週末レースの結果をDB取得
   - 予想との差分分析
   ↓
2. データ準備
   - 10年分のデータ取得
   - 特徴量生成
   ↓
3. モデル学習 (火曜23:00)
   - XGBoost, LightGBM, CatBoost
   - ハイパーパラメータチューニング
   ↓
4. 評価 & デプロイ
   - 既存モデルとの比較
   - 改善時のみデプロイ
   ↓
5. Discord通知
```

## ディレクトリ構造

```
keiba-yosou/
├── src/
│   ├── api/              # FastAPI
│   │   ├── routes/       # エンドポイント
│   │   └── schemas/      # Pydanticモデル
│   ├── db/               # DB接続
│   ├── discord/          # Discord Bot
│   ├── features/         # 特徴量抽出
│   ├── models/           # MLモデル
│   ├── scheduler/        # 定期ジョブ
│   └── services/         # ビジネスロジック
├── models/               # 学習済みモデル
├── tests/                # テスト
├── streamlit/            # ダッシュボード
└── docs/                 # ドキュメント
```

## 技術選定理由

| 技術 | 選定理由 |
|------|---------|
| FastAPI | 高性能、型安全、OpenAPI自動生成 |
| XGBoost | 表形式データで高精度 |
| LightGBM | 高速学習、メモリ効率 |
| CatBoost | カテゴリ変数の自動処理 |
| Docker Compose | 開発環境の再現性 |
| Ofelia | 軽量なジョブスケジューラー |

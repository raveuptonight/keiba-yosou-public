# ãƒ‡ãƒ¼ã‚¿åŒæœŸæˆ¦ç•¥

ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆJRA-VANãƒ‡ãƒ¼ã‚¿ï¼‰ã¨EC2ï¼ˆäºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ï¼‰é–“ã®ãƒ‡ãƒ¼ã‚¿å…±æœ‰æ–¹æ³•ã€‚

---

## ç¾åœ¨ã®æ§‹æˆ

```
[ãƒ­ãƒ¼ã‚«ãƒ« Windows/WSL]
â”œâ”€â”€ JV-Link (JRA-VAN API)
â”œâ”€â”€ mykeibadb
â””â”€â”€ PostgreSQL
    â”œâ”€â”€ jravan ã‚¹ã‚­ãƒ¼ãƒï¼ˆJRA-VANãƒ‡ãƒ¼ã‚¿ï¼‰
    â””â”€â”€ predictions ã‚¹ã‚­ãƒ¼ãƒï¼ˆäºˆæƒ³çµæœï¼‰

[EC2 Amazon Linux 2023]
â”œâ”€â”€ Discord Bot
â”œâ”€â”€ FastAPI
â””â”€â”€ PostgreSQLï¼ˆäºˆæƒ³çµæœã®ã¿ï¼‰
```

---

## é¸æŠè‚¢

### ğŸ”µ Option 1: S3çµŒç”±ã®å®šæœŸåŒæœŸï¼ˆæ¨å¥¨ãƒ»çŸ­æœŸï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚·ãƒ³ãƒ—ãƒ«
- ã‚»ã‚­ãƒ¥ã‚¢ï¼ˆVPNä¸è¦ï¼‰
- ã‚³ã‚¹ãƒˆä½ï¼ˆS3ã¯å®‰ã„ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã¯ãªã„ï¼ˆæ•°åˆ†ã€œæ•°æ™‚é–“é…å»¶ï¼‰
- ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„ã¨åŒæœŸæ™‚é–“ãŒã‹ã‹ã‚‹

**å®Ÿè£…:**

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆWindows/WSLï¼‰
pg_dump -U postgres -d keiba_db -n jravan > jravan_dump.sql
aws s3 cp jravan_dump.sql s3://your-bucket/keiba-data/

# EC2
aws s3 cp s3://your-bucket/keiba-data/jravan_dump.sql .
psql -U postgres -d keiba_db < jravan_dump.sql
```

**é »åº¦:** æ¯æ—¥1å›ï¼ˆæ·±å¤œï¼‰ã¾ãŸã¯é€±1å›

---

### ğŸŸ¢ Option 2: Neon PostgreSQLï¼ˆæ¨å¥¨ãƒ»ä¸­æœŸï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚¯ãƒ©ã‚¦ãƒ‰DBã€ã©ã“ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- æœˆé¡ã‚³ã‚¹ãƒˆï¼ˆç„¡æ–™æ ã‚ã‚Šï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«â†’Neonã¸ã®ç§»è¡Œä½œæ¥­ãŒå¿…è¦

**æ§‹æˆ:**

```
[ãƒ­ãƒ¼ã‚«ãƒ«] â†’ [Neon PostgreSQL] â† [EC2]
              (ä¸­å¤®DB)

- ãƒ­ãƒ¼ã‚«ãƒ«: å®šæœŸçš„ã«Neonã«åŒæœŸ
- EC2: Neonã‹ã‚‰ç›´æ¥èª­ã¿å–ã‚Š
```

**Neonç„¡æ–™æ :**
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 3GB
- è»¢é€: 5GB/æœˆ
- ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ: 300æ™‚é–“/æœˆ

---

### ğŸŸ¡ Option 3: SSH ãƒˆãƒ³ãƒãƒ«çµŒç”±æ¥ç¶šï¼ˆéæ¨å¥¨ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ 
- è¿½åŠ ã‚³ã‚¹ãƒˆä¸è¦

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«PCã‚’å¤–éƒ¨å…¬é–‹ï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«PCå¸¸æ™‚èµ·å‹•ãŒå¿…è¦
- é€šä¿¡é…å»¶

**å®Ÿè£…:** éæ¨å¥¨ã®ãŸã‚å‰²æ„›

---

### ğŸŸ  Option 4: REST APIçµŒç”±ï¼ˆè»½é‡ãƒ‡ãƒ¼ã‚¿å‘ã‘ï¼‰

**ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚»ã‚­ãƒ¥ã‚¢ãªå®Ÿè£…ãŒå¯èƒ½
- å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã ã‘å–å¾—

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ãƒ­ãƒ¼ã‚«ãƒ«ã§APIå®Ÿè£…ãŒå¿…è¦
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã«ã¯ä¸å‘ã

---

## æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### çŸ­æœŸï¼ˆç¾åœ¨ã€œ3ãƒ¶æœˆï¼‰: S3åŒæœŸï¼ˆæ‰‹å‹•å®Ÿè¡Œï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ­ãƒ¼ã‚«ãƒ« (Windows)   â”‚
â”‚  ãƒ»JRA-VAN          â”‚
â”‚  ãƒ»mykeibadb        â”‚
â”‚  ãƒ»PostgreSQL       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å¿…è¦ãªæ™‚ã«æ‰‹å‹•å®Ÿè¡Œ
       â”‚ ./sync_to_s3.sh
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AWS S3 Bucket     â”‚
â”‚  jravan_dump.sql    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å¿…è¦ãªæ™‚ã«æ‰‹å‹•å®Ÿè¡Œ
       â”‚ ./sync_from_s3.sh
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EC2                 â”‚
â”‚  ãƒ»Discord Bot      â”‚
â”‚  ãƒ»FastAPI          â”‚
â”‚  ãƒ»PostgreSQL       â”‚
â”‚    (JRA-VANèª­å–å°‚ç”¨)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°:**
- ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ™‚
- é€±1å›ç¨‹åº¦ï¼ˆã¾ãŸã¯å¿…è¦ã«å¿œã˜ã¦ï¼‰

**å®Ÿè£…å„ªå…ˆåº¦:** â˜…â˜…â˜…

---

### ä¸­æœŸï¼ˆ3ãƒ¶æœˆã€œï¼‰: Neonç§»è¡Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ­ãƒ¼ã‚«ãƒ« (Windows)   â”‚
â”‚  ãƒ»JRA-VAN          â”‚
â”‚  ãƒ»mykeibadb        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å®šæœŸåŒæœŸ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Neon PostgreSQL    â”‚
â”‚  ãƒ»jravan           â”‚
â”‚  ãƒ»predictions      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ èª­ã¿å–ã‚Š
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EC2                 â”‚
â”‚  ãƒ»Discord Bot      â”‚
â”‚  ãƒ»FastAPI          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…å„ªå…ˆåº¦:** â˜…â˜…â˜†

---

## å®Ÿè£…æ‰‹é †ï¼ˆS3åŒæœŸï¼‰

### 1. S3ãƒã‚±ãƒƒãƒˆä½œæˆ

```bash
aws s3 mb s3://keiba-yosou-data
```

### 2. ãƒ­ãƒ¼ã‚«ãƒ«åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ

`scripts/sync_to_s3.sh`:

```bash
#!/bin/bash
# JRA-VANãƒ‡ãƒ¼ã‚¿ã‚’S3ã«åŒæœŸ

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
DUMP_FILE="jravan_dump_${TIMESTAMP}.sql"

# PostgreSQLãƒ€ãƒ³ãƒ—ï¼ˆjravanã‚¹ã‚­ãƒ¼ãƒã®ã¿ï¼‰
pg_dump -U postgres -d keiba_db -n jravan > $DUMP_FILE

# S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
aws s3 cp $DUMP_FILE s3://keiba-yosou-data/dumps/

# æœ€æ–°ç‰ˆã¨ã—ã¦ã‚³ãƒ”ãƒ¼
aws s3 cp $DUMP_FILE s3://keiba-yosou-data/latest.sql

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm $DUMP_FILE

echo "Sync completed: $DUMP_FILE"
```

### 3. EC2åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ

`scripts/sync_from_s3.sh`:

```bash
#!/bin/bash
# S3ã‹ã‚‰JRA-VANãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

DUMP_FILE="latest.sql"

# S3ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
aws s3 cp s3://keiba-yosou-data/latest.sql $DUMP_FILE

# PostgreSQLã«ãƒªã‚¹ãƒˆã‚¢
psql -U postgres -d keiba_db < $DUMP_FILE

# ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm $DUMP_FILE

echo "Restore completed from S3"
```

### 4. æ‰‹å‹•å®Ÿè¡Œ

**ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆWindows/WSLï¼‰ã§S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:**

```bash
cd ~/keiba-yosou
./scripts/sync_to_s3.sh
```

**EC2ã§S3ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:**

```bash
cd ~/keiba-yosou
./scripts/sync_from_s3.sh
```

**è‡ªå‹•åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:**

å¿…è¦ã«å¿œã˜ã¦cronã‚„ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã§è‡ªå‹•åŒ–å¯èƒ½ã€‚
è©³ç´°ã¯ `docs/OPERATIONS.md` å‚ç…§ã€‚

---

## ã‚³ã‚¹ãƒˆè©¦ç®—ï¼ˆS3åŒæœŸï¼‰

**å‰æ:**
- ãƒ€ãƒ³ãƒ—ã‚µã‚¤ã‚º: 100MBï¼ˆåœ§ç¸®å¾Œï¼‰
- åŒæœŸé »åº¦: æ¯æ—¥1å›
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ap-northeast-1ï¼ˆæ±äº¬ï¼‰

**æœˆé¡ã‚³ã‚¹ãƒˆ:**
- S3ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 100MB Ã— $0.025/GB = $0.0025
- PUT ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: 30å› Ã— $0.0047/1000 = $0.00014
- GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: 30å› Ã— $0.00037/1000 = $0.000011
- ãƒ‡ãƒ¼ã‚¿è»¢é€ï¼ˆEC2â†’S3ï¼‰: ç„¡æ–™
- ãƒ‡ãƒ¼ã‚¿è»¢é€ï¼ˆS3â†’EC2ï¼‰: ç„¡æ–™

**åˆè¨ˆ: ç´„$0.003/æœˆï¼ˆç´„0.5å††ï¼‰**

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### IAMãƒ­ãƒ¼ãƒ«è¨­å®š

**ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆWSLï¼‰:**
```bash
aws configure
# ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼IDã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼è¨­å®š
```

**EC2:**
```bash
# IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¦EC2ã«ã‚¢ã‚¿ãƒƒãƒ
# S3èª­ã¿å–ã‚Šæ¨©é™ã®ã¿ä»˜ä¸ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ï¼‰
```

### S3ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::YOUR_ACCOUNT:role/EC2-Keiba-Role"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::keiba-yosou-data/*"
    }
  ]
}
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… S3åŒæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
2. âœ… å®šæœŸå®Ÿè¡Œè¨­å®šï¼ˆcron/ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ï¼‰
3. â¬œ å‹•ä½œç¢ºèª
4. â¬œ ã‚¨ãƒ©ãƒ¼é€šçŸ¥ï¼ˆDiscordï¼‰
5. â¬œ Neonç§»è¡Œæ¤œè¨ï¼ˆ3ãƒ¶æœˆå¾Œï¼‰

---

## ã¾ã¨ã‚

**ç¾æ™‚ç‚¹ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹:**

- **çŸ­æœŸ**: S3åŒæœŸï¼ˆä½ã‚³ã‚¹ãƒˆã€ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
- **ä¸­æœŸ**: Neonç§»è¡Œï¼ˆé‹ç”¨åŠ¹ç‡åŒ–ï¼‰

ã“ã‚Œã§ãƒ­ãƒ¼ã‚«ãƒ«ã®JRA-VANãƒ‡ãƒ¼ã‚¿ã‚’EC2ã®äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ ã§åˆ©ç”¨ã§ãã¾ã™ï¼
